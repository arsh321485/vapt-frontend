<template>
  <main>
    <section>
      <div class="container-fluid px-0">
        <div class="row gx-0 no-gutters">
          <DashboardHeader />
        </div>
        <div class="row">
          <div class="col-1 ps-0 menubar-col1">
            <DashboardMenu />
          </div>

          <div class="col-11 pt-5 pb-3 pe-5 ps-4">
            <div class="d-flex justify-content-between">
              <div>
                <p class="mt-4" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 15px;">Vulnerability card
                </p>
              </div>
              <div class="d-flex flex-row mt-4">
                <!-- <div class="dropdown mt-1">
                                <div class="dropdown-btn"> Select location</div>
                                  <div class="dropdown-content">
                                    <a href="#">Greece</a>
                                    <a href="#">Germany</a>
                                    <a href="#">Bahrain</a>
                                  </div>
                                </div> -->
                <select class="form-select rounded-pill" v-model="selectedLocation">
                  <option disabled value="">Select location</option>
                  <option value="germany">Germany</option>
                  <option value="delhi">Delhi</option>
                  <option value="bahrain">Bahrain</option>
                  <option value="greece">Greece</option>
                </select>
                <NotificationPanel />
              </div>
            </div>

            <div class="row">
              <div class="d-flex justify-content-between">
                <div class="d-flex justify-content-start gap-3">
                  <div class="d-flex justify-content-start gap-3">
                    <div class="fw-semibold" style="color: rgba(0, 0, 0, 0.87);">
                      <h5>{{ fixData?.host_name }}</h5>
                    </div>
                    <!-- <span class="d-flex align-items-center badge-critical">
                      <span class="rounded-circle me-1"
                        style="width: 6px; height: 6px; background-color: rgba(173, 0, 0, 1)"></span>
                      <span>{{ fixData?.risk_factor }}</span>
                    </span> -->
                    <span
  v-if="fixData?.risk_factor"
  class="d-flex align-items-center"
  :style="{
    color: getSeverityColor(fixData.risk_factor),
    backgroundColor: getSeverityBg(fixData.risk_factor),
    padding: '2px 8px',
    borderRadius: '12px',
    fontSize: '13px',
    fontWeight: '500'
  }"
>
  <span
    class="rounded-circle me-1"
    :style="{
      width: '6px',
      height: '6px',
      backgroundColor: getSeverityColor(fixData.risk_factor)
    }"
  ></span>

  <span>{{ fixData.risk_factor }}</span>
</span>

                    <span class="d-flex align-items-center badge-open">
                      <span class="rounded-circle me-1" style="width: 6px; height: 6px; background-color:white;"></span>
                      <span>{{ fixData?.status }}</span>
                    </span>
                  </div>

                  <div>
                    <button class="btn btn-sm text-light" style="background-color: rgba(49, 33, 177, 1);"
                      @click="openSupportModal">
                      Raise support requests
                    </button>
                  </div>
                  <!-- Raise support requests Modal -->
<div
  class="modal fade"
  id="supportModal"
  tabindex="-1"
  aria-labelledby="supportModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="supportModalLabel">
          Raise Support Request
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

<!-- <div class="modal-body">

  <div v-if="!isSupportAlreadyRaised">
    <h6>Choose the step for which you want to support</h6>

    <div class="row g-2 mt-2">
      <div class="col-4">
        <span
          @click="toggleAllSteps"
          class="badge rounded-pill w-100 py-2 text-center"
          :class="isAllSelected ? 'bg-primary text-light' : 'bg-light text-dark border'"
          style="cursor: pointer; font-size: 12px;"
        >
          All Steps
        </span>
      </div>

      <div class="col-4" v-for="n in 6" :key="n">
        <span
          @click="toggleStep(n)"
          class="badge rounded-pill w-100 py-2 text-center"
          :class="selectedSteps.includes(n) ? 'bg-primary text-light' : 'bg-light text-dark border'"
          style="cursor: pointer; font-size: 12px;"
        >
          Step {{ n }}: Code review
        </span>
      </div>
    </div>

    <p class="mt-3 fw-semibold">
      Description <span class="text-danger">*</span>
    </p>

    <textarea
      v-model="supportDescription"
      class="form-control rounded-0"
      rows="4"
      placeholder="Write your issue here..."
    ></textarea>

    <small v-if="showValidation" class="text-danger">
      Description is required.
    </small>
  </div>

  <div v-else>
    <p><strong>Requested Step:</strong> {{ supportDetail.step_requested }}</p>

    <p class="fw-semibold mt-3">Description</p>
    <textarea
      class="form-control rounded-0"
      rows="4"
      :value="supportDetail.description"
      disabled
    ></textarea>

    <p class="mt-3"><strong>Status:</strong> {{ supportDetail.status }}</p>

    <p class="fw-semibold mt-3">Assigned Team</p>
    <ul class="mb-0">
      <li
        v-for="m in supportDetail.assigned_team_members"
        :key="m.user_id"
      >
        {{ m.name }} ({{ m.email }})
      </li>
    </ul>
  </div>

</div> -->
<div class="modal-body">
  <h6>Choose the step for which you want to support</h6>

  <div class="row g-2 mt-2">
    <div class="col-4">
      <span
        class="badge rounded-pill w-100 py-2 text-center"
        :class="isAllSelected ? 'bg-primary text-light' : 'bg-light text-dark border'"
        style="cursor:pointer;font-size:12px"
        @click="!isSupportAlreadyRaised && toggleAllSteps()"
      >
        All Steps
      </span>
    </div>

    <div class="col-4" v-for="n in 6" :key="n">
      <span
        class="badge rounded-pill w-100 py-2 text-center"
        :class="selectedSteps.includes(n)
          ? 'bg-primary text-light'
          : 'bg-light text-dark border'"
        style="cursor:pointer;font-size:12px"
        @click="!isSupportAlreadyRaised && toggleStep(n)"
      >
        Step {{ n }}: Code review
      </span>
    </div>
  </div>

  <p class="mt-3 fw-semibold">
    Description <span class="text-danger">*</span>
  </p>

  <textarea
    v-model="supportDescription"
    class="form-control rounded-0"
    rows="4"
    placeholder="Write your issue here..."
    :disabled="isSupportAlreadyRaised"
  ></textarea>
</div>

<!-- <div class="modal-footer">
  <button
    v-if="!isSupportAlreadyRaised"
    class="btn btn-primary"
    :disabled="!supportDescription"
    @click="submitSupport"
  >
    Submit
  </button>

  <button
    v-else
    class="btn btn-secondary"
    data-bs-dismiss="modal"
  >
    Close
  </button>
</div> -->

    <div class="modal-footer">
  <button
    v-if="!isSupportAlreadyRaised"
    class="btn btn-primary"
    :disabled="!supportDescription"
    @click="submitSupport"
  >
    Submit
  </button>

  <button
    v-else
    class="btn btn-secondary"
    data-bs-dismiss="modal"
  >
    Close
  </button>
</div>  

    </div>
  </div>
</div>
                  <div>
                    <button class="btn btn-sm mb-1 text-light"
                      style="background-color: rgba(49, 33, 177, 1);font-weight: 500;font-size: 14px;"
                      @click="toggleRow">Related </button>
                  </div>
                </div>
                <div class="pt-1">
                  
                    <button
  class="btn btn-ticket btn-sm text-light" style="background-color: rgba(49, 33, 177, 1);"
  @click="goToCreateTicket"
>
  Create Ticket
</button>
                </div>
              </div>

            </div>
            <hr>
            <div class="row">
              <div class="col-9">
                <div class="row">
                  <div class="row">
                    <div class="col-6">
                      <p class="mt-2 mb-1" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 14px;">
                        Vulnerability name</p>
                      <p class="mt-0 pt-0" style="color: rgba(0, 0, 0, 0.87);font-size: 15px;font-weight: 500;">{{
                        fixData?.plugin_name }}</p>
                    </div>
                    <div class="col-6">
                      <p class="mt-2 mb-1" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 14px;">Assigned
                        Team</p>
                      <div class="position-relative d-inline-block">
                        <p class="mt-0 pt-0"
                          style="color: rgba(0, 0, 0, 0.87); font-size: 15px; font-weight: 500; cursor: pointer;"
                          @mouseenter="showMembers = true" @mouseleave="showMembers = false">
                          {{ fixData?.assigned_team }}
                        </p>
                        <!-- Hover list -->
                        <div v-if="showMembers" class="position-absolute bg-light border rounded shadow p-2"
                          style="top: 70%; left: 0; width: 170px; z-index: 10;">
                          <strong class="">Team Members ({{ members.length }})</strong>
                          <ul class="mt-2 mb-0 ps-2">

                            <li v-for="(m, i) in members" :key="i" class="list-unstyled">
                              <i class="bi bi-person me-2 text-primary"></i>{{ m }}
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row" v-if="showFirstRow">
                  <div class="row">
                    <div class="col-6">
                      <p class="mt-3 mb-1" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 14px;">
                        Vulnerability Type</p>
                      <p class="mt-0 pt-0" style="color: rgba(0, 0, 0, 0.87);font-size: 15px;font-weight: 500;">{{
                        fixData?.vulnerability_type }}</p>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-6">
                      <p class="mt-3 mb-1" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 14px;">Affected
                        Port/Ranges</p>
                      <p class="mt-0 pt-0" style="color: rgba(0, 0, 0, 0.87);font-size: 15px;font-weight: 500;">{{
                        fixData?.affected_ports }}</p>
                    </div>
                    <div class="col-6">
                      <p class="mt-3 mb-1" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 14px;">file Path
                      </p>
                      <p class="mt-0 pt-0" style="color: rgba(0, 0, 0, 0.87);font-size: 15px;font-weight: 500;">{{
                        fixData?.file }}</p>
                    </div>

                  </div>
                  <div class="row">
                    <div class="col-12">
                      <p class="mt-3 mb-1" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 14px;">
                        Description</p>
                      <p class="mt-0 pt-0" style="color: rgba(0, 0, 0, 0.87);font-size: 15px;font-weight: 500;">{{
                        fixData?.description_points }}</p>
                    </div>

                  </div>
                  <div class="row">
                    <div class="col-12">
                      <p class=" mb-1" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 13px;"><i
                          class="bi bi-check-circle me-1"></i>Vendor fix available</p>

                    </div>
                  </div>
                </div>

                <!-- Alternate Row -->
                <div v-else class="row">
                  <div class="col">
                    <table class="table table-bordered table-striped">
                      <tbody>
                        <tr>
                          <th scope="row">Resource ID</th>
                          <td>
                            arn:aws:lambda:eu-central-1:211125372003:function:fra-sto-shr-uat-lda-evt-mgr-dbmigration:$LATEST
                          </td>
                        </tr>
                        <tr>
                          <th scope="row">Region</th>
                          <td>eu-central-1</td>
                        </tr>
                        <tr>
                          <th scope="row">Affected Packages</th>
                          <td>org.springframework:spring-web</td>
                        </tr>
                        <tr>
                          <th scope="row">Vendor Advisory</th>
                          <td><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-22259"
                              target="_blank">https://nvd.nist.gov/vuln/detail/CVE-2024-22259</a></td>
                        </tr>
                        <tr>
                          <th scope="row">Reference Url</th>
                          <td>
                            <ul class="list-unstyled lh-base">
                              <li><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-22259"
                                  target="_blank">https://nvd.nist.gov/vuln/detail/CVE-2024-22259</a></li>
                              <li><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-22259"
                                  target="_blank">https://nvd.nist.gov/vuln/detail/CVE-2024-22259</a></li>
                            </ul>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div class="row pe-5">
                  <div class="d-flex justify-content-between">
                    <h5 class="mt-4 mb-3" style="color: rgba(49, 33, 177, 1);font-size: 24px;font-weight: 600;">Steps to
                      fix ({{ steps.length }})</h5>
                    <div class="mt-3">
                      <button class="btn btn-secondary btn-sm" @click="goToRow1">
                        Mark Steps Incomplete</button>
                    </div>
                  </div>
                </div>

                <div class="row" v-if="showRow1">
                  <div class="row pe-5">

                    <div class="card p-4" style="border-radius: 24px;">
                      
                      <div class="stepper-card d-flex justify-content-between align-items-start w-100">
                        <div v-for="(step, index) in steps" :key="index" class="step-wrapper d-flex align-items-start">
                          <!-- STEP CONTENT -->
                          <div class="step text-center" style="margin-right: 15px;" :class="{
                            'active-step': index + 1 === currentStep,
                            'completed-step': completedSteps.includes(index + 1),
                            'remaining-step': index + 1 > currentStep
                          }">
                            <div class="step-title">Step {{ index + 1 }}</div>
                            <div class="step-label">
                              Code review
                            </div>
                            <!-- DOT (ONLY ACTIVE STEP) -->
                            <div v-if="index + 1 === currentStep" class="step-dot active-dot mt-1"></div>
                          </div>
                          <div v-if="index !== steps.length - 1" class="flex-grow-1 mx-2 my-auto"
                            :class="completedSteps.includes(index + 1) ? 'line-completed' : 'line-pending'"></div>

                          <!-- <div v-if="index !== steps.length - 1" class="flex-grow-1 border-top mx-2 my-auto"></div> -->
                        </div>
                      </div>

                      <div class="d-flex justify-content-start my-4 gap-4">
                        <div class="d-flex flex-row gap-2" style="margin-top: 3px;">
                          <span style="color: rgba(0, 0, 0, 0.6);font-size: 13px;">Assigned to:</span>
                          <p style="font-size: 14px;">{{ steps[currentStep - 1]?.assigned_to }}</p>
                          <!-- <span class="avatar-container" style="margin-top: -10px;">
                                                <span class="avatar ava-green">GM</span>
                                                <span class="avatar ava-blue">UK</span>
                                                <span class="avatar ava-yellow">BH</span>
                                                <div class="avatar ava-black">+3</div>
                                            </span> -->

                        </div>
                        <div>
                          <span style="color: rgba(0, 0, 0, 0.6);font-size: 13px;">Deadline:</span>
                          <span style="color: rgba(0, 0, 0, 0.87);font-size: 14px;">{{ steps[currentStep - 1]?.deadline
                          }}</span>
                          <!-- <span style="color: rgba(49, 33, 177, 1);font-size: 15px;font-weight: 600;"> Edit</span> -->
                        </div>
                        <div>
                          <span style="color: rgba(0, 0, 0, 0.6);font-size: 13px;">Artifacts/Tools used:</span>
                          <span style="color: rgba(0, 0, 0, 0.87);font-size: 14px;"> {{ steps[currentStep -
                            1]?.artifacts_tools_used }}</span>
                          <span style="color: rgba(49, 33, 177, 1);font-size: 15px;margin-top: -5px;font-weight: 600">
                            <i class="bi bi-info-circle ms-1"></i></span>
                        </div>
                      </div>
                      <p class="mt-3 mb-2" style="color: rgba(0, 0, 0, 0.87);font-size: 16px;font-weight: 500;">{{
                        steps[currentStep - 1]?.description }}</p>
                      <div class="p-4 mb-3" style="background-color: rgba(246, 246, 246, 1);">
                        <div class="mb-3" style="color: rgba(0, 0, 0, 0.6);font-size: 14px;">System file path: <span
                            style="color: rgba(0, 0, 0, 0.87);">{{ steps[currentStep - 1]?.system_file_path }}</span>
                        </div>
                        <!-- <p style="color: rgba(0, 0, 0, 0.87);font-size: 15px;font-weight: 500;">Review all .aspx and .cs files for instances of ‚ÄúResponse.Redirect‚Äù, ‚ÄúServer.Transfer‚Äù and output statements like ‚ÄúResponse.Write‚Äù.</p> -->
                      </div>

                      <div class="d-flex justify-content-end">
                        <div class="d-flex flex-row gap-2">
                          <button class="btn text-light" style="background-color: rgba(49, 33, 177, 1);"
                            :disabled="currentStep === 1" @click="prevStep">Back</button>
                          <!-- <button class="btn text-light" style="background-color: rgba(49, 33, 177, 1);" @click="goToRow2">Step Completed</button> -->
                          <button class="btn text-light" style="background-color: rgba(49, 33, 177, 1);"
                            @click="nextStep">
                            {{ isLastStep ? 'Step Completed' : 'Next Step' }}
                          </button>
                        </div>
                      </div>

                    </div>
                  </div>

                  <div class="row my-5 pe-5">
                    <div class="card p-4" style="border-radius: 24px;">
                      <div class="p-4" style="background-color: rgba(246, 246, 246, 1);">
                        <div class="mb-3" style="color: rgba(0, 0, 0, 0.6);font-size: 14px;">Comment: <span
                            style="color: rgba(0, 0, 0, 0.87);">Step 1</span></div>
                        <textarea class="form-control rounded-0" rows="3"
                          placeholder="If you sort this by any other method, mention it in the comment."></textarea>
                      </div>
                      <div class="d-flex justify-content-end mt-3">
                        <button class="btn btn-sm text-light"
                          style="background-color: rgba(49, 33, 177, 1);">Submit</button>
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="text-center">
                      <button class="btn btn-sm btn-primary" @click="showRow = !showRow">If you are not able to solve
                        with the given fixes check this</button>
                    </div>

                    <div class="row mb-3 mt-3 pe-4" v-if="showRow">
                      <div class="card p-4 mt-4" style="border-radius: 24px;">
                        <!-- <h5 class="ps-3">If you are not able to solve this issue, please make sure you have followed these steps:</h5> -->
                        <ul class="list-unstyled mb-0">
                          <li>
                            <input type="checkbox" class="form-check-input me-2" id="chk1">
                            <label for="chk1">Please check server status</label>
                          </li>
                          <li>
                            <input type="checkbox" class="form-check-input me-2" id="chk2">
                            <label for="chk2">Verify network connectivity</label>
                          </li>
                          <li>
                            <input type="checkbox" class="form-check-input me-2" id="chk3">
                            <label for="chk3">Confirm admin permissions</label>
                          </li>
                          <li>
                            <input type="checkbox" class="form-check-input me-2" id="chk4">
                            <label for="chk4">Ensure patch is available</label>
                          </li>
                          <li>
                            <input type="checkbox" class="form-check-input me-2" id="chk5">
                            <label for="chk5">Validate dependency versions</label>
                          </li>
                        </ul>

                      </div>
                    </div>
                  </div>
                </div>

                <div v-else class="row pe-5">
                  <div class="card p-5" style="border-radius: 24px;">
                    <p class="mb-3">üéâ Congratulations you have completed all steps!</p>
                    <label for="feedback" class="form-label fw-semibold">Leave a feedback</label>
                    <textarea id="feedback" v-model="feedback" class="form-control mb-3 rounded-0" rows="3"
                      placeholder="Write your feedback here..."></textarea>

                    <div class="d-flex justify-content-end gap-3">
                      <!-- <button class="btn btn-dark" @click="goToRow1"><i class="bi bi-chevron-left me-2"></i>
                                        Back to Steps
                                      </button> -->
                      <button class="btn btn-dark" @click="goBackSteps">
                        Back to Steps
                      </button>
                      <button class="btn text-light" style="background-color:rgba(49, 33, 177, 1) ;">
                        Submit
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-3">
                <p class="mt-2" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 15px;">Timeline</p>
                <div class="timeline-wrapper">
                  <div class="timeline-step">
                    <div class="timeline-icon">
                      <i class="bi bi-caret-right-fill text-primary"></i>
                    </div>
                    <div class="timeline-content">
                      <p class="fw-semibold mb-1">Vulnerability identified</p>
                      <p class="text-muted small">23rd July, 2025</p>
                    </div>
                  </div>

                  <div class="timeline-step">
                    <div class="timeline-icon">
                      <i class="bi bi-caret-right-fill text-primary"></i>
                    </div>
                    <div class="timeline-content">
                      <p class="fw-semibold mb-1">Assigned to Team</p>
                      <p class="text-muted small">23rd July, 2025</p>
                    </div>
                  </div>

                  <div class="timeline-step">
                    <div class="timeline-icon">
                      <i class="bi bi-caret-right-fill text-primary"></i>
                    </div>
                    <div class="timeline-content">
                      <p class="fw-semibold mb-1">Deadline</p>
                      <p class="text-muted small">2nd Aug, 2025</p>
                    </div>
                  </div>

                  <div class="timeline-step" style="margin-top: 70px;">
                    <div class="timeline-icon">
                      <i class="bi bi-check-circle-fill text-primary"></i>
                    </div>
                    <div class="timeline-content">
                      <p class="fw-semibold mb-1">Step 1 Done</p>
                      <p class="text-muted small">20 Aug, 2025</p>
                    </div>
                  </div>

                  <div class="timeline-step">
                    <div class="timeline-icon">
                      <i class="bi bi-check-circle-fill text-primary"></i>
                    </div>
                    <div class="timeline-content">
                      <p class="fw-semibold mb-1">Step 2 Done</p>
                      <p class="text-muted small">28 Aug, 2025</p>
                    </div>
                  </div>

                  <div class="timeline-step">
                    <div class="timeline-icon">
                      <i class="bi bi-exclamation-circle text-primary"></i>
                    </div>
                    <div class="timeline-content">
                      <p class="fw-semibold mb-1">Exception Requested</p>
                      <p class="text-muted small">2nd sept, 2025</p>
                    </div>
                  </div>

                  <div class="timeline-step">
                    <div class="timeline-icon">
                      <i class="bi bi-question-circle text-primary"></i>
                    </div>
                    <div class="timeline-content">
                      <p class="fw-semibold mb-1">Create Ticket</p>
                      <p class="text-muted small">2nd sept, 2025</p>
                    </div>
                  </div>

                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</template>

<script>
import DashboardMenu from "@/components/admin-component/DashboardMenu.vue";
import DashboardHeader from "@/components/admin-component/DashboardHeader.vue";
import NotificationPanel from "@/components/admin-component/NotificationPanel.vue";
import { useAuthStore } from "@/stores/authStore";

export default {
  name: "Vulnerability Card",
  components: {
    DashboardMenu,
    DashboardHeader,
    NotificationPanel
  },
  data() {
    return {
      authStore: useAuthStore(),
      isSupportAlreadyRaised: false,
      fixData: null,
      loading: false,
      currentStep: 1,
      feedback: "",
      showFirstRow: true,
      completedSteps: [],
      showRow1: true,
      showMembers: false,
      selectedSteps: [],
      isAllSelected: false,
      showRow: false,
      supportDescription: "",
      supportDetail: null,
      showValidation: false,
      selectedLocation: "greece",
    };
  },
  computed: {
    members() {
      return this.fixData?.assigned_team_members?.map(m => m.name) || [];
    },
    steps() {
      return this.fixData?.mitigation_steps || [];
    },
    isLastStep() {
      return this.currentStep === this.steps.length;
    },
   
  },
  created() {
  const { vulId } = this.$route.params;
  console.log("Current vulnerability id:", vulId);
},
  watch: {
    $route: {
      immediate: true,
      handler() {
        this.fetchFixVulnerability();
      }
    }
  },
  methods: {
    getSelectedStepLabel() {
  if (this.isAllSelected) return "All Steps";

  return this.selectedSteps
    .map(n => `Step ${n}`)
    .join(", ");
},
    getSeverityColor(sev) {
    if (sev === "Critical") return "maroon";
    if (sev === "High") return "red";
    if (sev === "Medium") return "orange";
    return "green"; // Low
  },

  getSeverityBg(sev) {
    if (sev === "Critical") return "#fdeaea";
    if (sev === "High") return "rgb(246 214 214)";
    if (sev === "Medium") return "rgb(249 225 193)";
    return "rgb(202 233 204)";
  },
    nextStep() {
      // mark current as completed
      if (!this.completedSteps.includes(this.currentStep)) {
        this.completedSteps.push(this.currentStep);
      }

      // if last step ‚Üí show congratulations screen
      if (this.currentStep === this.steps.length) {
        this.showRow1 = false;
        return;
      }

      // move to next step
      this.currentStep++;
    },
    prevStep() {
      if (this.currentStep > 1) {
        this.currentStep--;
      }
    },
    goBackSteps() {
      this.showRow1 = true;
      this.currentStep = this.steps.length;
    },
    toggleStep(step) {
      if (this.isAllSelected) return;

      if (this.selectedSteps.includes(step)) {
        this.selectedSteps = this.selectedSteps.filter(s => s !== step);
      } else {
        this.selectedSteps.push(step);
      }
    },
    toggleAllSteps() {
      if (this.isAllSelected) {
        this.isAllSelected = false;
        this.selectedSteps = [];
      } else {
        this.isAllSelected = true;
        this.selectedSteps = this.steps.map((_, i) => i + 1);
      }
    },
    toggleRow() {
      this.showFirstRow = !this.showFirstRow;
    },
    goToRow2() {
      this.showRow1 = false;
    },
    goToRow1() {
      this.showRow1 = true;
    },
    showList() {
      this.showMembers = true;
    },
    hideList() {
      this.showMembers = false;
    },
    async submitSupport() {
  if (!this.supportDescription.trim()) {
    this.showValidation = true;
    return;
  }

  const payload = {
    step: this.getSelectedStepLabel(),
    description: this.supportDescription
  };

  const res = await this.authStore.raiseSupportRequest(
    this.fixData.report_id,
    this.fixData._id,
    payload
  );

  if (res.status) {
    this.isSupportAlreadyRaised = true;

    const modal = bootstrap.Modal.getInstance(
      document.getElementById("supportModal")
    );
    modal.hide();
  }
},
    async openSupportModal() {
  // reset UI
  this.isSupportAlreadyRaised = false;
  this.selectedSteps = [];
  this.isAllSelected = false;
  this.supportDescription = "";
  this.supportDetail = null;

  const vulnerabilityId = this.fixData?._id;

  if (!vulnerabilityId) {
    console.warn("No vulnerability ID found");
    return;
  }

  // üîç CALL NEW API
  const res =
    await this.authStore.getRaiseSupportRequestByVulnerability(
      vulnerabilityId
    );

  if (res.status && res.exists && res.data) {
    const existing = res.data;

    // ‚úÖ mark already raised
    this.isSupportAlreadyRaised = true;
    this.supportDetail = existing;

    // ‚úÖ description
    this.supportDescription = existing.description || "";

    // ‚úÖ steps
    if (existing.step_requested === "All Steps") {
      this.isAllSelected = true;
      this.selectedSteps = [];
    } else {
      const stepNo = this.parseStepNumber(
        existing.step_requested
      );
      if (stepNo) this.selectedSteps = [stepNo];
    }
  }

  await this.$nextTick();

  const modal = new bootstrap.Modal(
    document.getElementById("supportModal")
  );
  modal.show();
},
    parseStepNumber(step) {
  const match = step?.match(/\d+/);
  return match ? Number(match[0]) : null;
},
    async fetchFixVulnerability() {
      const { asset, reportId } = this.$route.params;

      if (!asset || !reportId) {
        console.warn("Missing route params", { asset, reportId });
        return;
      }

      console.log("Calling Fix API:", reportId, asset);

      this.loading = true;

      const res = await this.authStore.createFixVulnerability(
        reportId,
        asset,
        {} // body
      );

      this.loading = false;

      console.log("Fix API response:", res);

      if (res.status) {
        this.fixData = res.data;
      }
    },
    goToCreateTicket() {
  if (
    !this.fixData?._id ||
    !this.fixData?.host_name ||
    !this.fixData?.report_id
  ) {
    console.error("Missing fix vulnerability data", this.fixData);
    return;
  }

  this.$router.push({
    name: "CreateTicket",
    params: {
      reportId: this.fixData.report_id,   // ‚úÖ REQUIRED
      fixVulId: this.fixData._id,          // ‚úÖ REQUIRED
      asset: this.fixData.host_name        // UI only
    }
  });
},
  },

  mounted() {
    const dropdown = document.querySelector('.dropdown');
    if (!dropdown) return;

    const btn = dropdown.querySelector('.dropdown-btn');
    const options = dropdown.querySelectorAll('.dropdown-content a');

    if (!btn) return;

    btn.addEventListener('click', () => {
      dropdown.classList.toggle('show');
    });

    options.forEach(option => {
      option.addEventListener('click', (e) => {
        e.preventDefault();
        btn.textContent = option.textContent;
        dropdown.classList.remove('show');
      });
    });

    document.addEventListener('click', (e) => {
      if (!dropdown.contains(e.target)) {
        dropdown.classList.remove('show');
      }
    });


  },

};
</script>

<style scoped>
.badge-critical {
  background-color: rgba(255, 225, 225, 1);
  color: rgba(173, 0, 0, 1);
  font-weight: 600;
  font-size: 0.75rem;
  padding: 4px 8px;
  border-radius: 8px;
  height: 30px;
}

.badge-open {
  background-color: rgb(194, 60, 60);
  color: white;
  font-weight: 600;
  font-size: 0.75rem;
  padding: 4px 8px;
  border-radius: 8px;
  height: 30px;
}

.stepper-card {
  position: relative;
  padding-top: 5px;
}

.line-completed {
  height: 1px;
  background-color: rgba(49, 33, 177, 1);
}

.line-pending {
  height: 1px;
  background-color: #d0d7de;
}

.completed-step .step-label {
  color: rgba(49, 33, 177, 1);
  font-weight: 600;
}

.completed-step .step-title {
  color: rgba(0, 0, 0, 0.85);
}

.active-step .step-label {
  /* color: rgba(49, 33, 177, 1); */
  font-weight: 600;
  color: #007b8f;
}

.active-step .step-title {
  color: #000;
}

.remaining-step .step-label {
  color: rgba(0, 0, 0, 0.35);
  /* light grey */
  font-weight: 500;
}

.remaining-step .step-title {
  color: rgba(0, 0, 0, 0.35);
}

.step-line {
  flex-grow: 1;
  height: 1px;
  background-color: #d0d7de;
  margin-top: 22px;
}

.step {
  position: relative;
  z-index: 1;
  flex: 1;
}

.step-title {
  font-size: 12px;
  color: rgba(0, 0, 0, 0.6);
  font-size: 13px;
  font-weight: 500;
}

.step-label {
  font-size: 15px;
  color: rgba(0, 140, 156, 1);
  font-weight: 500;
  line-height: 18px;
  min-height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}

.step-dot {
  width: 6px;
  height: 6px;
  background-color: rgba(49, 33, 177, 1);
  border-radius: 50%;
  margin: 0 auto;
}

.active-step .step-title {
  color: #000;
}

.active-step .step-label {
  color: #007b8f;
  font-weight: 600;
}


.timeline-wrapper {
  position: relative;
  padding-left: 30px;
  border-left: 1px solid #e0e0e0;
  height: 930px;
}

.timeline-title {
  font-weight: 500;
  font-size: 15px;
  color: rgba(0, 0, 0, 1);
  margin-bottom: 1rem;
}

.timeline-step {
  position: relative;
  display: flex;
  align-items: flex-start;
  margin-bottom: 30px;
}

.timeline-icon {
  position: absolute;
  left: -40px;
  top: 0;
  background-color: rgba(255, 255, 255, 1);
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 2px 8px 12px rgba(0, 0, 0, 0.12);
}

.timeline-icon img {
  width: 10px;
  height: 10px;
}

.timeline-content {
  padding-left: 20px;
}

.dropdown {
  position: relative;
  display: inline-block;
  width: 200px;
}

.dropdown-btn {
  background-color: white;
  border: 1px solid rgba(0, 0, 0, 0.16);
  border-radius: 50px;
  padding: 4px 20px 4px 12px;
  /* extra right padding for the arrow */
  cursor: pointer;
  position: relative;
}

.dropdown-btn::after {
  content: "‚ñº";
  /* arrow symbol */
  font-size: 12px;
  color: #333;
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  min-width: 100%;
  border-radius: 12px;
  box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
  z-index: 1;
  margin-top: 4px;
}

.dropdown-content a {
  padding: 8px 12px;
  display: block;
  text-decoration: none;
  color: black;
  border-radius: 8px;
}

.dropdown-content a:hover {
  background-color: #f1f1f1;
}

.dropdown.show .dropdown-content {
  display: block;
}
</style>