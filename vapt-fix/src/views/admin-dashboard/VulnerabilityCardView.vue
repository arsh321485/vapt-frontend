<template>
  <main>
    <section>
      <div class="container-fluid px-0">
        <div class="row gx-0 no-gutters">
          <DashboardHeader />
        </div>
        <div class="row">
          <div class="col-1 ps-0 menubar-col1">
            <DashboardMenu />
          </div>

          <div class="col-11 pt-5 pb-3 pe-5 ps-4">
            <div class="d-flex justify-content-between">
              <div>
                <p class="mt-4" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 15px;">Vulnerability card
                </p>
              </div>
              <div class="d-flex flex-row mt-4">
                <NotificationPanel />
              </div>
            </div>

            <div class="row">
              <div class="d-flex justify-content-between">
                <div class="d-flex justify-content-start gap-3">
                  <div class="d-flex justify-content-start gap-3">
                    <div class="fw-semibold" style="color: rgba(0, 0, 0, 0.87);">
                      <h5>{{ fixData?.asset }}</h5>
                    </div>

                    <span v-if="fixData?.severity" class="d-flex align-items-center" :style="{
                      color: getSeverityColor(fixData.severity),
                      backgroundColor: getSeverityBg(fixData.severity),
                      padding: '2px 8px',
                      borderRadius: '12px',
                      fontSize: '13px',
                      fontWeight: '500'
                    }">

                      <span class="rounded-circle me-1" :style="{
                        width: '6px',
                        height: '6px',
                        backgroundColor: getSeverityColor(fixData.severity)
                      }"></span>
                      <span>{{ fixData.severity }}</span>
                    </span>

                    <span class="d-flex align-items-center"
                      :class="fixData?.status === 'open' ? 'badge-open' : 'badge-close'">
                      <span class="rounded-circle me-1" style="width:6px; height:6px; background-color:white;"></span>

                      <span class="text-capitalize">
                        {{ fixData?.status }}
                      </span>
                    </span>
                    <!-- <span class="d-flex align-items-center badge-open">
                      <span class="rounded-circle me-1" style="width: 6px; height: 6px; background-color:white;"></span>
                      <span>{{ fixData?.status }}</span>
                    </span> -->

                    <span v-if="isReadOnly" class="d-flex align-items-center badge-readonly">
                      <i class="bi bi-lock-fill me-1"></i>
                      <span>Read-Only</span>
                    </span>
                  </div>

                  <div>
                    <button class="btn btn-sm text-light" style="background-color: rgba(49, 33, 177, 1);"
                      @click="openSupportModal">
                      Raise support requests
                    </button>
                  </div>
                  <!-- Raise support requests Modal -->
                  <div class="modal fade" id="supportModal" tabindex="-1" aria-labelledby="supportModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content">

                        <div class="modal-header">
                          <h5 class="modal-title" id="supportModalLabel">
                            Raise Support Request
                          </h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>


                        <div class="modal-body">
                          <h6>Choose the step for which you want to support</h6>

                          <div class="row g-2 mt-2">
                            <div class="col-4">
                              <span class="badge rounded-pill w-100 py-2 text-center"
                                :class="isAllSelected ? 'bg-primary text-light' : 'bg-light text-dark border'"
                                style="cursor:pointer;font-size:12px"
                                @click="!isSupportAlreadyRaised && toggleAllSteps()">
                                All Steps
                              </span>
                            </div>

                            <!-- <div v-if="isSupportAlreadyRaised" class="alert alert-warning">
  Support request already raised for this vulnerability
</div> -->

                            <div class="col-4" v-for="n in 6" :key="n">
                              <span class="badge rounded-pill w-100 py-2 text-center" :class="selectedSteps.includes(n)
                                ? 'bg-primary text-light'
                                : 'bg-light text-dark border'" style="cursor:pointer;font-size:12px"
                                @click="!isSupportAlreadyRaised && toggleStep(n)">
                                Step {{ n }}: Code review
                              </span>
                            </div>
                          </div>

                          <p class="mt-3 fw-semibold">
                            Description <span class="text-danger">*</span>
                          </p>

                          <textarea v-model="supportDescription" class="form-control rounded-0" rows="4"
                            placeholder="Write your issue here..." :disabled="isSupportAlreadyRaised"></textarea>
                        </div>

                        <div class="modal-footer">
                          <button v-if="!isSupportAlreadyRaised" class="btn btn-primary" :disabled="!supportDescription"
                            @click="submitSupport">
                            Submit
                          </button>

                          <button v-else class="btn btn-secondary" data-bs-dismiss="modal">
                            Close
                          </button>
                        </div>

                      </div>
                    </div>
                  </div>

                  <div>
                    <button class="btn btn-sm mb-1 text-light"
                      style="background-color: rgba(49, 33, 177, 1);font-weight: 500;font-size: 14px;"
                      @click="toggleRow">Related </button>
                  </div>
                </div>
                <div class="pt-1">

                  <button class="btn btn-ticket btn-sm text-light" style="background-color: rgba(49, 33, 177, 1);"
                    @click="goToCreateTicket">
                    Create Ticket
                  </button>
                </div>
              </div>

            </div>
            <hr>
            <div class="row">
              <div class="col-9">
                <div class="row">
                  <div class="row">
                    <div class="col-6">
                      <p class="mt-2 mb-1" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 14px;">
                        Vulnerability name</p>
                      <p class="mt-0 pt-0" style="color: rgba(0, 0, 0, 0.87);font-size: 15px;font-weight: 500;">{{
                        fixData?.vulnerability_name }}</p>
                    </div>
                    <div class="col-6">
                      <p class="mt-2 mb-1" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 14px;">Assigned
                        Team</p>
                      <div class="position-relative d-inline-block">
                        <p class="mt-0 pt-0"
                          style="color: rgba(0, 0, 0, 0.87); font-size: 15px; font-weight: 500; cursor: pointer;"
                          @mouseenter="showMembers = true" @mouseleave="showMembers = false">
                          {{ fixData?.assigned_team }}
                        </p>
                        <!-- Hover list -->
                        <div v-if="showMembers" class="position-absolute bg-light border rounded shadow p-2"
                          style="top: 70%; left: 0; width: 170px; z-index: 10;">
                          <strong class="">Team Members ({{ members.length }})</strong>
                          <ul class="mt-2 mb-0 ps-2">

                            <li v-for="(m, i) in members" :key="i" class="list-unstyled">
                              <i class="bi bi-person me-2 text-primary"></i>{{ m }}
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row" v-if="showFirstRow">
                  <div class="row">
                    <div class="col-6">
                      <p class="mt-3 mb-1" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 14px;">
                        Vulnerability Type</p>
                      <p class="mt-0 pt-0" style="color: rgba(0, 0, 0, 0.87);font-size: 15px;font-weight: 500;">{{
                        fixData?.vulnerability_type }}</p>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-6">
                      <p class="mt-3 mb-1" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 14px;">Affected
                        Port/Ranges</p>
                      <p class="mt-0 pt-0" style="color: rgba(0, 0, 0, 0.87);font-size: 15px;font-weight: 500;">{{
                        fixData?.affected_ports_ranges }}</p>
                    </div>
                    <div class="col-6">
                      <p class="mt-3 mb-1" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 14px;">file Path
                      </p>
                      <p class="mt-0 pt-0" style="color: rgba(0, 0, 0, 0.87);font-size: 15px;font-weight: 500;">{{
                        fixData?.file_path }}</p>
                    </div>

                  </div>
                  <div class="row">
                    <div class="col-12">
                      <p class="mt-3 mb-1" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 14px;">
                        Description</p>
                      <p class="mt-0 pt-0" style="color: rgba(0, 0, 0, 0.87);font-size: 15px;font-weight: 500;">{{
                        fixData?.description }}</p>
                    </div>

                  </div>
                  <div class="row">
                    <div class="col-12">
                      <p class=" mb-1" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 13px;"><i
                          class="bi bi-check-circle me-1"></i>Vendor fix available</p>

                    </div>
                  </div>
                </div>

                <!-- Alternate Row -->
                <div v-else class="row">
                  <div class="col">
                    <table class="table table-bordered table-striped">
                      <tbody>
                        <tr>
                          <th scope="row">Resource ID</th>
                          <td>
                            arn:aws:lambda:eu-central-1:211125372003:function:fra-sto-shr-uat-lda-evt-mgr-dbmigration:$LATEST
                          </td>
                        </tr>
                        <tr>
                          <th scope="row">Region</th>
                          <td>eu-central-1</td>
                        </tr>
                        <tr>
                          <th scope="row">Affected Packages</th>
                          <td>org.springframework:spring-web</td>
                        </tr>
                        <tr>
                          <th scope="row">Vendor Advisory</th>
                          <td><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-22259"
                              target="_blank">https://nvd.nist.gov/vuln/detail/CVE-2024-22259</a></td>
                        </tr>
                        <tr>
                          <th scope="row">Reference Url</th>
                          <td>
                            <ul class="list-unstyled lh-base">
                              <li><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-22259"
                                  target="_blank">https://nvd.nist.gov/vuln/detail/CVE-2024-22259</a></li>
                              <li><a href="https://nvd.nist.gov/vuln/detail/CVE-2024-22259"
                                  target="_blank">https://nvd.nist.gov/vuln/detail/CVE-2024-22259</a></li>
                            </ul>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div class="row pe-5">
                  <div class="d-flex justify-content-between">
                    <h5 class="mt-4 mb-3" style="color: rgba(49, 33, 177, 1);font-size: 24px;font-weight: 600;">Steps to
                      fix ({{ steps.length }})</h5>
                    <div class="mt-3">
                      <button class="btn btn-secondary btn-sm" @click="goToRow1">
                        Mark Steps Incomplete</button>
                    </div>
                  </div>
                </div>

                <div class="row" v-if="showRow1">
                  <div class="row pe-5">

                    <div class="card p-4" style="border-radius: 24px;">

                      <div class="stepper-card d-flex justify-content-between align-items-start w-100">
                        <div v-for="(step, index) in steps" :key="index" class="step-wrapper d-flex align-items-start">
                          <!-- STEP CONTENT -->
                          <div class="step text-center" style="margin-right: 15px;" :class="{
                            'completed-step': completedSteps.includes(index + 1),
                            'active-step': !completedSteps.includes(index + 1) && index + 1 === currentStep,
                            'remaining-step': !completedSteps.includes(index + 1) && index + 1 > currentStep
                          }">
                            <div class="step-title">Step {{ index + 1 }}</div>
                            <div class="step-label">
                              Code review
                            </div>
                            <!-- DOT (ONLY ACTIVE STEP) -->
                            <div v-if="index + 1 === currentStep" class="step-dot active-dot mt-1"></div>
                          </div>
                          <div v-if="index !== steps.length - 1" class="flex-grow-1 mx-2 my-auto"
                            :class="completedSteps.includes(index + 1) ? 'line-completed' : 'line-pending'"></div>

                          <!-- <div v-if="index !== steps.length - 1" class="flex-grow-1 border-top mx-2 my-auto"></div> -->
                        </div>
                      </div>

                      <div class="d-flex justify-content-start my-4 gap-4">
                        <div class="d-flex flex-row gap-2" style="margin-top: 3px;">
                          <span style="color: rgba(0, 0, 0, 0.6);font-size: 13px;">Assigned to:</span>
                          <div ref="membersWrapper" class="avatar-container d-flex align-items-center"
                            style="margin-top: -10px;">
                            <!-- show first 3 members -->
                            <span v-for="(member, index) in visibleMembers" :key="index" class="avatar"
                              :class="getAvatarColor(index)" :title="member.name">
                              {{ getInitials(member.name) }}
                            </span>
                            <!-- + count circle -->
                            <div v-if="remainingMembersCount > 0" class="avatar ava-black" style="cursor:pointer;"
                              @click="toggleMembersPopup">
                              +{{ remainingMembersCount }}
                            </div>
                            <!-- popup -->
                            <div v-if="showMembersPopup" class="position-absolute bg-white border rounded shadow p-3"
                              style="top:154px; left:160px; width:220px; z-index:100;">
                              <strong>Team Members ({{ currentStepMembers.length }})</strong>

                              <ul class="mt-2 mb-0 ps-2">
                                <li v-for="(m, i) in currentStepMembers" :key="i" class="list-unstyled mb-1">
                                  <i class="bi bi-person me-2 text-primary"></i>
                                  {{ m.name }}
                                </li>
                              </ul>
                            </div>
                          </div>

                        </div>
                        <div>
                          <span style="color: rgba(0, 0, 0, 0.6);font-size: 13px;">Deadline:</span>
                          <span style="color: rgba(0, 0, 0, 0.87);font-size: 14px;">{{ steps[currentStep - 1]?.deadline
                            || 'N/A'
                            }}</span>

                        </div>
                        <div>
                          <span style="color: rgba(0, 0, 0, 0.6);font-size: 13px;">Artifacts/Tools used:</span>
                          <span style="color: rgba(0, 0, 0, 0.87);font-size: 14px;"> {{ steps[currentStep -
                            1]?.artifacts_tools_used }}</span>
                          <span style="color: rgba(49, 33, 177, 1);font-size: 15px;margin-top: -5px;font-weight: 600">
                            <i class="bi bi-info-circle ms-1"></i></span>
                        </div>
                      </div>

                      <div class="p-4 mb-3" style="background-color: rgba(246, 246, 246, 1);">
                        <div v-if="steps[currentStep - 1]?.system_file_path" class="mb-3"
                          style="color: rgba(0, 0, 0, 0.6);font-size: 14px;">
                          System file path:
                          <span style="color: rgba(0, 0, 0, 0.87);">
                            {{ steps[currentStep - 1]?.system_file_path }}
                          </span>
                        </div>
                      </div>

                      <div class="d-flex justify-content-end">
                        <div class="d-flex flex-row gap-2">
                          <button class="btn text-light" style="background-color: rgba(49, 33, 177, 1);"
                            :disabled="currentStep === 1 || isReadOnly" @click="prevStep">
                            Back
                          </button>

                          <button class="btn text-light" style="background-color: rgba(49, 33, 177, 1);"
                            @click="nextStep" :disabled="savingStep || isReadOnly">
                            <span v-if="savingStep">
                              <i class="bi bi-hourglass-split me-2"></i>Saving...
                            </span>
                            <span v-else>
                              {{ isLastStep ? 'Step Completed' : 'Next Step' }}
                            </span>
                          </button>
                        </div>
                      </div>

                    </div>
                  </div>

                  <div class="row my-5 pe-5">
                    <div class="card p-4" style="border-radius: 24px;">
                      <div class="p-4" style="background-color: rgba(246, 246, 246, 1);">
                        <div class="mb-3" style="color: rgba(0, 0, 0, 0.6);font-size: 14px;">Comment: <span
                            style="color: rgba(0, 0, 0, 0.87);">Step {{ currentStep }}</span></div>
                        <textarea v-model="currentStepComment" class="form-control rounded-0" rows="3"
                          :disabled="isCommentLocked"
                          placeholder="If you sorted this by any other method, mention it in the comment.">
                        </textarea>
                      </div>
                      <!-- <div class="d-flex justify-content-end mt-3">
                        <button class="btn btn-sm text-light"
                          style="background-color: rgba(49, 33, 177, 1);">Submit</button>
                      </div> -->
                    </div>
                  </div>

                  <div class="row">
                    <div class="text-center">
                      <button class="btn btn-sm btn-primary" @click="showRow = !showRow">If you are not able to solve
                        with the given fixes check this</button>
                    </div>

                    <div class="row mb-3 mt-3 pe-4" v-if="showRow">
                      <div class="card p-4 mt-4" style="border-radius: 24px;">
                        <!-- <h5 class="ps-3">If you are not able to solve this issue, please make sure you have followed these steps:</h5> -->
                        <ul class="list-unstyled mb-0">
                          <li>
                            <input type="checkbox" class="form-check-input me-2" id="chk1">
                            <label for="chk1">Please check server status</label>
                          </li>
                          <li>
                            <input type="checkbox" class="form-check-input me-2" id="chk2">
                            <label for="chk2">Verify network connectivity</label>
                          </li>
                          <li>
                            <input type="checkbox" class="form-check-input me-2" id="chk3">
                            <label for="chk3">Confirm admin permissions</label>
                          </li>
                          <li>
                            <input type="checkbox" class="form-check-input me-2" id="chk4">
                            <label for="chk4">Ensure patch is available</label>
                          </li>
                          <li>
                            <input type="checkbox" class="form-check-input me-2" id="chk5">
                            <label for="chk5">Validate dependency versions</label>
                          </li>
                        </ul>
                        <div class="d-flex justify-content-end mt-3">
                          <button class="btn btn-sm text-light"
                            style="background-color: rgba(49, 33, 177, 1);">Submit</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- feedback -->
                <div v-else class="row pe-5">
                  <div class="card p-5" style="border-radius: 24px;">

                    <p class="mb-3">üéâ Vulnerability Closed</p>

                    <!-- show existing feedback -->
                    <div v-if="finalFeedbackData">

                      <p class="fw-semibold mb-1">Feedback</p>
                      <p class="mb-3">{{ finalFeedbackData.feedback_comment }}</p>

                      <p class="fw-semibold mb-1">Result</p>
                      <span class="badge bg-success text-uppercase">
                        {{ finalFeedbackData.fix_result }}
                      </span>

                      <p class="mt-3 text-muted" style="font-size:13px;">
                        Submitted at:
                        {{ finalFeedbackData.submitted_at }}
                      </p>

                    </div>

                    <!-- show form if not submitted -->
                    <div v-else>

                      <label class="form-label fw-semibold">Leave a feedback</label>

                      <textarea v-model="feedback" class="form-control mb-3 rounded-0" rows="3"
                        placeholder="Write your feedback here..."></textarea>

                      <div class="d-flex justify-content-end gap-3">
                        <button class="btn btn-dark" @click="goBackSteps">
                          Back to Steps
                        </button>

                        <button class="btn text-light" style="background-color:rgba(49,33,177,1)"
                          @click="submitFinalFeedback">
                          Submit
                        </button>
                      </div>

                    </div>

                  </div>
                </div>

                <!-- <div v-else class="row pe-5">
                  <div class="card p-5" style="border-radius: 24px;">
                    <p class="mb-3">üéâ Congratulations you have completed all steps!</p>
                    <label for="feedback" class="form-label fw-semibold">Leave a feedback</label>
                    <textarea id="feedback" v-model="feedback" class="form-control mb-3 rounded-0" rows="3"
                      placeholder="Write your feedback here..."></textarea>

                    <div class="d-flex justify-content-end gap-3">
                    
                      <button class="btn btn-dark" @click="goBackSteps">
                        Back to Steps
                      </button>
                      <button
  class="btn text-light"
  style="background-color:rgba(49, 33, 177, 1)"
  @click="submitFinalFeedback"
  :disabled="submittingFeedback"
>
  {{ submittingFeedback ? "Submitting..." : "Submit" }}
</button>
                     
                    </div>
                  </div>
                </div> -->

              </div>
              <div class="col-3">
                <p class="mt-2" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 15px;">Timeline</p>
                <div class="timeline-wrapper">
                  <div class="timeline-step">
                    <div class="timeline-icon">
                      <i class="bi bi-caret-right-fill text-primary"></i>
                    </div>
                    <div class="timeline-content">
                      <p class="fw-semibold mb-1">Vulnerability identified</p>
                      <p class="text-muted small">23rd July, 2025</p>
                    </div>
                  </div>

                  <div class="timeline-step">
                    <div class="timeline-icon">
                      <i class="bi bi-caret-right-fill text-primary"></i>
                    </div>
                    <div class="timeline-content">
                      <p class="fw-semibold mb-1">Assigned to Team</p>
                      <p class="text-muted small">23rd July, 2025</p>
                    </div>
                  </div>

                  <div class="timeline-step">
                    <div class="timeline-icon">
                      <i class="bi bi-caret-right-fill text-primary"></i>
                    </div>
                    <div class="timeline-content">
                      <p class="fw-semibold mb-1">Deadline</p>
                      <p class="text-muted small">2nd Aug, 2025</p>
                    </div>
                  </div>

                  <div class="timeline-step" style="margin-top: 70px;">
                    <div class="timeline-icon">
                      <i class="bi bi-check-circle-fill text-primary"></i>
                    </div>
                    <div class="timeline-content">
                      <p class="fw-semibold mb-1">Step 1 Done</p>
                      <p class="text-muted small">20 Aug, 2025</p>
                    </div>
                  </div>

                  <div class="timeline-step">
                    <div class="timeline-icon">
                      <i class="bi bi-check-circle-fill text-primary"></i>
                    </div>
                    <div class="timeline-content">
                      <p class="fw-semibold mb-1">Step 2 Done</p>
                      <p class="text-muted small">28 Aug, 2025</p>
                    </div>
                  </div>

                  <div class="timeline-step">
                    <div class="timeline-icon">
                      <i class="bi bi-exclamation-circle text-primary"></i>
                    </div>
                    <div class="timeline-content">
                      <p class="fw-semibold mb-1">Exception Requested</p>
                      <p class="text-muted small">2nd sept, 2025</p>
                    </div>
                  </div>

                  <div class="timeline-step">
                    <div class="timeline-icon">
                      <i class="bi bi-question-circle text-primary"></i>
                    </div>
                    <div class="timeline-content">
                      <p class="fw-semibold mb-1">Create Ticket</p>
                      <p class="text-muted small">2nd sept, 2025</p>
                    </div>
                  </div>

                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</template>

<script>
import DashboardMenu from "@/components/admin-component/DashboardMenu.vue";
import DashboardHeader from "@/components/admin-component/DashboardHeader.vue";
import NotificationPanel from "@/components/admin-component/NotificationPanel.vue";
import { useAuthStore } from "@/stores/authStore";

export default {
  name: "Vulnerability Card",
  components: {
    DashboardMenu,
    DashboardHeader,
    NotificationPanel
  },
  data() {
    return {
      authStore: useAuthStore(),
      isSupportAlreadyRaised: false,
      fixData: null,
      loading: false,
      currentStep: 1,
      feedback: "",
      showFirstRow: true,
      completedSteps: [],
      showRow1: true,
      showMembers: false,
      selectedSteps: [],
      isAllSelected: false,
      showRow: false,
      supportDescription: "",
      supportDetail: null,
      showValidation: false,
      selectedLocation: "greece",
      stepCompletionData: null,    // Stores step completion response
      isReadOnly: false,            // Read-only mode when status is "close"
      currentStepComment: "",       // Comment for current step
      savingStep: false,            // Loading state for step save
      showMembersPopup: false,
      feedback: "",
      submittingFeedback: false,
      finalFeedbackData: null,
      loadingFinalFeedback: false,
    };
  },
  computed: {
    members() {
      return this.fixData?.assigned_team_members?.map(m => m.name) || [];
    },
    steps() {
      return this.stepCompletionData?.steps || [];
    },
    isLastStep() {
      return this.currentStep === this.steps.length;
    },
    currentStepMembers() {
      return (
        this.stepCompletionData?.steps?.[this.currentStep - 1]
          ?.assigned_team_members || []
      );
    },
    visibleMembers() {
      return this.currentStepMembers.slice(0, 3);
    },
    remainingMembersCount() {
      return this.currentStepMembers.length - 3;
    },
    isCommentLocked() {
      if (this.isReadOnly) return true;

      const step = this.stepCompletionData?.steps?.find(
        s => s.step_number === this.currentStep
      );

      // lock only if comment already exists
      return step?.comment ? true : false;
    },
  },
  created() {
    const { vulId } = this.$route.params;
    console.log("Current vulnerability id:", vulId);
  },
  watch: {
    $route: {
      immediate: true,
      handler() {
        this.fetchFixVulnerability();
      }
    },
    currentStep: {
      immediate: true,
      handler(step) {
        this.loadStepComment(step);
      }
    }
  },
  methods: {
    loadStepComment(stepNumber) {

      const stepData = this.stepCompletionData?.steps?.find(
        s => s.step_number === stepNumber
      );

      if (!stepData) {
        this.currentStepComment = "";
        return;
      }

      // if comment already saved ‚Üí show it
      if (stepData.comment) {
        this.currentStepComment = stepData.comment;
      } else {
        // new step
        this.currentStepComment = "";
      }
    },
    async submitFinalFeedback() {

      if (!this.feedback.trim()) {
        Swal.fire({
          icon: "warning",
          title: "Feedback required",
          text: "Please enter feedback",
          timer: 1800,
          showConfirmButton: false
        });
        return;
      }

      if (!this.fixData?._id) {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Fix vulnerability not found",
          timer: 1800,
          showConfirmButton: false
        });
        return;
      }

      this.submittingFeedback = true;

      const payload = {
        feedback_comment: this.feedback,
        fix_result: "resolved"   // static for now
      };

      const res = await this.authStore.submitFixFinalFeedback(
        this.fixData._id,
        payload
      );

      this.submittingFeedback = false;

      if (res.status) {
        Swal.fire({
          icon: "success",
          title: "Submitted",
          text: "Feedback submitted successfully",
          timer: 1800,
          showConfirmButton: false
        });

        // Set finalFeedbackData directly from submitted values
        // so UI switches to showing the submitted feedback
        this.finalFeedbackData = res.data || {
          feedback_comment: this.feedback,
          fix_result: "resolved",
          submitted_at: new Date().toISOString()
        };

        this.feedback = "";
        this.isReadOnly = true;

      } else {
        Swal.fire({
          icon: "error",
          title: "Failed",
          text: res.message || "Failed to submit feedback",
          timer: 2000,
          showConfirmButton: false
        });
      }
    },
    async fetchFinalFeedback() {
      console.log("FINAL FEEDBACK GET CALLED");
      if (!this.fixData?._id) return;

      this.loadingFinalFeedback = true;

      const res = await this.authStore.getFixFinalFeedback(this.fixData._id);

      this.loadingFinalFeedback = false;

      if (res.status) {
        this.finalFeedbackData = res.data.final_feedback;

        console.log("Final feedback loaded:", this.finalFeedbackData);

        // if feedback exists ‚Üí make read only
        if (this.finalFeedbackData) {
          this.isReadOnly = true;
        }

      } else {
        console.warn("No final feedback found");
      }
    },
    toggleMembersPopup() {
      this.showMembersPopup = !this.showMembersPopup;
    },
    handleOutsideClick(event) {
      const wrapper = this.$refs.membersWrapper;

      if (wrapper && !wrapper.contains(event.target)) {
        this.showMembersPopup = false;
      }
    },
    getInitials(name) {
      if (!name) return "";
      return name
        .split(" ")
        .map(word => word[0])
        .join("")
        .toUpperCase()
        .slice(0, 2);
    },
    getAvatarColor(index) {
      const colors = ["ava-green", "ava-blue", "ava-yellow"];
      return colors[index % colors.length];
    },
    getSelectedStepLabel() {
      if (this.isAllSelected) return "All Steps";

      return this.selectedSteps
        .map(n => `Step ${n}`)
        .join(", ");
    },
    getSeverityColor(sev) {
      if (sev === "Critical") return "maroon";
      if (sev === "High") return "red";
      if (sev === "Medium") return "orange";
      return "green"; // Low
    },
    getSeverityBg(sev) {
      if (sev === "Critical") return "#fdeaea";
      if (sev === "High") return "rgb(246 214 214)";
      if (sev === "Medium") return "rgb(249 225 193)";
      return "rgb(202 233 204)";
    },
    async nextStep() {

      if (this.isReadOnly) {
        console.log("Cannot modify - vulnerability is closed");
        return;
      }

      // Save step
      if (!this.completedSteps.includes(this.currentStep)) {

        this.savingStep = true;

        const payload = {
          step_number: this.currentStep,
          status: "completed",   // ‚úÖ NEW REQUIRED FIELD
          comment:
            this.currentStepComment ||
            `Step ${this.currentStep} completed`
        };

        const res = await this.authStore.completeFixVulnerabilityStep(
          this.fixData._id,
          payload
        );

        this.savingStep = false;

        if (res.status) {
          console.log("Step saved:", res);

          this.completedSteps.push(this.currentStep);

          // üî• Update status from backend
          if (res.vulnerability_status) {
            this.fixData.status = res.vulnerability_status;
          }

          // reload from backend (sets currentStep to next_step)
          await this.fetchStepCompletionData(this.fixData._id);

          // reload comment for the new current step
          this.loadStepComment(this.currentStep);

          // üî• IF CLOSED ‚Üí LOAD FINAL FEEDBACK
          if (res.vulnerability_status === "closed") {
            await this.fetchFinalFeedback();
          }

          // Last step finished ‚Üí show feedback
          if (this.currentStep > this.steps.length || this.completedSteps.length === this.steps.length) {
            this.showRow1 = false;
          }

          return; // fetchStepCompletionData already set currentStep
        } else {
          Swal.fire({
            icon: "error",
            title: "Failed",
            text: `Failed to save step: ${res.message}`,
            timer: 2000,
            showConfirmButton: false
          });
          return;
        }
      }

      // Already completed step ‚Äî just move forward
      if (this.currentStep === this.steps.length) {
        this.showRow1 = false;
        return;
      }

      this.currentStep++;
    },
    prevStep() {
      if (this.currentStep > 1) {
        this.currentStep--;
      }
    },
    goBackSteps() {
      this.showRow1 = true;
      this.currentStep = this.steps.length;
    },
    toggleStep(step) {
      if (this.isAllSelected) return;

      if (this.selectedSteps.includes(step)) {
        this.selectedSteps = this.selectedSteps.filter(s => s !== step);
      } else {
        this.selectedSteps.push(step);
      }
    },
    toggleAllSteps() {
      if (this.isAllSelected) {
        this.isAllSelected = false;
        this.selectedSteps = [];
      } else {
        this.isAllSelected = true;
        this.selectedSteps = this.steps.map((_, i) => i + 1);
      }
    },
    toggleRow() {
      this.showFirstRow = !this.showFirstRow;
    },
    goToRow2() {
      this.showRow1 = false;
    },
    goToRow1() {
      this.showRow1 = true;
    },
    showList() {
      this.showMembers = true;
    },
    hideList() {
      this.showMembers = false;
    },
    async submitSupport() {

      if (!this.supportDescription.trim()) {
        this.showValidation = true;

        Swal.fire({
          icon: "warning",
          title: "Description required",
          text: "Please enter support description",
          timer: 1800,
          showConfirmButton: false
        });

        return;
      }

      if (!this.fixData?._id) {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Vulnerability not found",
          timer: 1800,
          showConfirmButton: false
        });
        return;
      }

      // step conversion
      let stepValue = "all";

      if (!this.isAllSelected && this.selectedSteps.length > 0) {
        stepValue = this.selectedSteps.join(",");
      }

      const payload = {
        step: stepValue,
        description: this.supportDescription
      };

      console.log("Support payload:", payload);

      const res = await this.authStore.raiseSupportRequest(
        this.fixData.report_id,
        this.fixData._id,
        payload
      );

      if (res.status) {

        this.isSupportAlreadyRaised = true;
        this.supportDetail = res.data;

        // close modal
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("supportModal")
        );
        modal.hide();

        // ‚úÖ Sweet success auto close
        Swal.fire({
          icon: "success",
          title: "Support Raised",
          text: "Support request raised successfully",
          timer: 1800,
          showConfirmButton: false
        });

      } else {

        Swal.fire({
          icon: "error",
          title: "Failed",
          text: res.message || "Failed to raise support request",
          timer: 2000,
          showConfirmButton: false
        });
      }
    },
    async openSupportModal() {

      console.log("üî• Opening support modal");

      // reset UI
      this.isSupportAlreadyRaised = false;
      this.selectedSteps = [];
      this.isAllSelected = false;
      this.supportDescription = "";
      this.supportDetail = null;

      const vulnerabilityId = this.fixData?._id;

      if (!vulnerabilityId) {
        console.warn("No vulnerability ID found");
        return;
      }

      console.log("Checking existing support request...");

      const res =
        await this.authStore.getRaiseSupportRequestByVulnerability(
          vulnerabilityId
        );

      console.log("Support API response:", res);

      if (res.status && res.exists && res.data) {

        const existing = res.data;

        // already raised
        this.isSupportAlreadyRaised = true;
        this.supportDetail = existing;

        // description
        this.supportDescription = existing.description || "";

        if (existing.step_requested?.toLowerCase() === "all") {

          this.isAllSelected = true;
          this.selectedSteps = [];

        } else {

          this.isAllSelected = false;

          // handle "1,3" or "2,4,5"
          const stepsArray = existing.step_requested
            .split(",")
            .map(s => Number(s.trim()))
            .filter(n => !isNaN(n));

          this.selectedSteps = stepsArray;
        }

      }

      await this.$nextTick();

      const modal = new bootstrap.Modal(
        document.getElementById("supportModal")
      );
      modal.show();
    },
    parseStepNumber(step) {
      const match = step?.match(/\d+/);
      return match ? Number(match[0]) : null;
    },
    async fetchFixVulnerability() {

      const { asset, reportId } = this.$route.params;
      const { id, plugin_name, risk_factor } = this.$route.query;

      if (!asset || !reportId) {
        console.warn("Missing route params");
        return;
      }

      if (!plugin_name) {
        console.error("plugin_name missing from route");
        return;
      }

      this.loading = true;

      // STEP 1Ô∏è‚É£ ‚Üí Check closed vulnerabilities (always works)
      console.log("üîç Checking existing vulnerabilities...");

      const closed = await this.authStore.getClosedVulnerabilities(reportId, asset);

      if (closed.status && closed.data?.count > 0) {

        console.log("‚úÖ Existing fix vulnerabilities found for asset:", closed.data.count);

        // Find the specific vulnerability matching the plugin_name from query
        const closedFix = closed.data.results.find(
          v => v.vulnerability_name === plugin_name || v.plugin_name === plugin_name
        ) || null;

        if (closedFix) {
          console.log("‚úÖ Matched existing vulnerability:", plugin_name);
          const fixId = closedFix.fix_vulnerability_id || closedFix._id;
          await this.loadFixDetails(fixId, closedFix);
          return;
        }

        console.log("‚ö†Ô∏è No match for plugin_name in closed results, creating new...");
      }

      // STEP 2Ô∏è‚É£ ‚Üí No existing fix ‚Äî CREATE NEW
      console.log("üÜï No existing fix found ‚Äî creating new one...");
if (!id) {
  console.error("‚ùå Missing vulnerability register ID");
  this.loading = false;
  return;
}
      const payload = {
        id,
        plugin_name,
        risk_factor
      };

      const res = await this.authStore.createFixVulnerability(
        reportId,
        asset,
        payload
      );

      this.loading = false;

      if (res.status) {
        this.fixData = res.data;

        if (this.fixData._id) {
          await this.fetchStepCompletionData(this.fixData._id);
        }
        // If vulnerability closed ‚Üí show feedback section
        if (this.fixData.status?.toLowerCase() === "closed") {
          this.showRow1 = false;
          await this.fetchFinalFeedback();
        }

      } else {
        console.error("Fix create failed:", res.message, res.details);
        alert(res.message || "Failed to create fix vulnerability");
      }
    },

    // Helper: load fix details by ID with fallback data
    async loadFixDetails(fixId, fallbackData) {

      // Fetch full card details via dedicated GET detail API
      // const cardResult = await this.authStore.getFixVulnerabilityCard(fixId);
      const cardResult = await this.authStore.fetchFixVulnerabilityCardDetails(fixId);


      if (cardResult.status && cardResult.data) {
        this.fixData = cardResult.data;
        // Detail API returns fix_vulnerability_id instead of _id
        if (!this.fixData._id) {
          this.fixData._id = this.fixData.fix_vulnerability_id || fixId;
        }
      } else {
        // Fallback to the passed data if detail API fails
        console.warn("‚ö†Ô∏è Detail API failed, using fallback data:", cardResult.message);
        this.fixData = fallbackData;
        if (!this.fixData._id) {
          this.fixData._id = fixId;
        }
      }

      this.loading = false;

      // read only if closed
      if (this.fixData.status?.toLowerCase() === "closed") {
        this.isReadOnly = true;
      }

      // load steps with full data (includes assigned_team_members per step)
      await this.fetchStepCompletionData(fixId);

      // If vulnerability closed ‚Üí show feedback section
      if (this.fixData.status?.toLowerCase() === "closed") {
        this.showRow1 = false;
        await this.fetchFinalFeedback();
      }
    },
    async fetchStepCompletionData(id) {
      console.log("STEP GET API CALLED");   // debug

      const res = await this.authStore.getFixVulnerabilitySteps(id);

      if (!res.status) return;

      // API only returns completed steps ‚Äî build full 6-step array
      const totalSteps = res.data.total_steps || 6;
      const apiSteps = res.data.steps || [];

      const defaultDescriptions = [
        "Initial Assessment - Identify and document the vulnerability scope",
        "Risk Analysis - Evaluate potential impact and prioritize remediation",
        "Solution Planning - Design and document the fix approach",
        "Implementation - Apply the fix or mitigation",
        "Testing & Validation - Verify the fix resolves the vulnerability",
        "Documentation & Closure - Complete documentation and close the issue"
      ];

      const fullSteps = [];
      for (let i = 1; i <= totalSteps; i++) {
        const existing = apiSteps.find(s => s.step_number === i);
        if (existing) {
          fullSteps.push(existing);
        } else {
          fullSteps.push({
            step_number: i,
            step_description: defaultDescriptions[i - 1] || `Step ${i}`,
            assigned_team: res.data.vulnerability_status === "open" ? (this.fixData?.assigned_team || "") : "",
            assigned_team_members: this.fixData?.assigned_team_members || [],
            deadline: null,
            status: "pending",
            comment: null,
            feedback: null
          });
        }
      }

      this.stepCompletionData = {
        ...res.data,
        steps: fullSteps
      };

      this.completedSteps = fullSteps
        .filter(s => s.status === "completed")
        .map(s => s.step_number);

      // Set current step to next pending step
      if (res.data.next_step) {
        this.currentStep = res.data.next_step;
      }

      console.log("Completed Steps:", this.completedSteps);
    },
    goToCreateTicket() {
      if (
        !this.fixData?._id ||
        !this.fixData?.asset ||
        !this.fixData?.report_id
      ) {
        console.error("Missing fix vulnerability data", this.fixData);
        return;
      }
      this.$router.push({
        name: "CreateTicket",
        params: {
          reportId: this.fixData.report_id,
          fixVulId: this.fixData._id,
          asset: encodeURIComponent(this.fixData.asset)
        },
        //   query: {
        //     asset: this.fixData.asset,
        //     plugin: this.fixData.vulnerability_name
        // }
      }).catch(err => {
        console.log("Router error:", err);
      });
    },
  },
  mounted() {
    document.addEventListener("click", this.handleOutsideClick);
    // ‚úÖ Bootstrap tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));

    // ‚úÖ Dropdown handling (safe DOM check)
    const dropdown = document.querySelector('.dropdown');

    if (dropdown) {
      const btn = dropdown.querySelector('.dropdown-btn');
      const options = dropdown.querySelectorAll('.dropdown-content a');

      if (btn) {
        btn.addEventListener('click', () => {
          dropdown.classList.toggle('show');
        });
      }

      options.forEach(option => {
        option.addEventListener('click', (e) => {
          e.preventDefault();
          if (btn) btn.textContent = option.textContent;
          dropdown.classList.remove('show');
        });
      });

      document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target)) {
          dropdown.classList.remove('show');
        }
      });
    }

    // üî• Debug log for page mount
    console.log("üî• Vulnerability Fix Card mounted");
  },
  beforeUnmount() {
    document.removeEventListener("click", this.handleOutsideClick);
  },

};
</script>

<style scoped>
.badge-critical {
  background-color: rgba(255, 225, 225, 1);
  color: rgba(173, 0, 0, 1);
  font-weight: 600;
  font-size: 0.75rem;
  padding: 4px 8px;
  border-radius: 8px;
  height: 30px;
}

.badge-close {
  background-color: #28a745;
  /* green */
  color: white;
  font-weight: 600;
  font-size: 0.75rem;
  padding: 4px 8px;
  border-radius: 8px;
  height: 30px;
}

.badge-open {
  background-color: rgb(194, 60, 60);
  color: white;
  font-weight: 600;
  font-size: 0.75rem;
  padding: 4px 8px;
  border-radius: 8px;
  height: 30px;
}

.stepper-card {
  position: relative;
  padding-top: 5px;
}

.line-completed {
  height: 1px;
  background-color: rgba(49, 33, 177, 1);
}

.line-pending {
  height: 1px;
  background-color: #d0d7de;
}

/* .completed-step {
  background-color: #e3f2fd;
  color: #1976d2;
} */

.active-step {
  /* border: 2px solid #1976d2; */
  font-weight: 600;
}

.completed-step .step-label {
  color: rgba(49, 33, 177, 1);
  font-weight: 600;
}

.completed-step .step-title {
  color: rgba(0, 0, 0, 0.85);
}

.active-step .step-label {
  /* color: rgba(49, 33, 177, 1); */
  font-weight: 600;
  color: #007b8f;
}

.active-step .step-title {
  color: #000;
}

.remaining-step .step-label {
  color: rgba(0, 0, 0, 0.35);
  /* light grey */
  font-weight: 500;
}

.remaining-step .step-title {
  color: rgba(0, 0, 0, 0.35);
}

.step-line {
  flex-grow: 1;
  height: 1px;
  background-color: #d0d7de;
  margin-top: 22px;
}

.step {
  position: relative;
  z-index: 1;
  flex: 1;
}

.step-title {
  font-size: 12px;
  color: rgba(0, 0, 0, 0.6);
  font-size: 13px;
  font-weight: 500;
}

.step-label {
  font-size: 15px;
  color: rgba(0, 140, 156, 1);
  font-weight: 500;
  line-height: 18px;
  min-height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}

.step-dot {
  width: 6px;
  height: 6px;
  background-color: rgba(49, 33, 177, 1);
  border-radius: 50%;
  margin: 0 auto;
}

.active-step .step-title {
  color: #000;
}

.active-step .step-label {
  color: #007b8f;
  font-weight: 600;
}


.timeline-wrapper {
  position: relative;
  padding-left: 30px;
  border-left: 1px solid #e0e0e0;
  height: 930px;
}

.timeline-title {
  font-weight: 500;
  font-size: 15px;
  color: rgba(0, 0, 0, 1);
  margin-bottom: 1rem;
}

.timeline-step {
  position: relative;
  display: flex;
  align-items: flex-start;
  margin-bottom: 30px;
}

.timeline-icon {
  position: absolute;
  left: -40px;
  top: 0;
  background-color: rgba(255, 255, 255, 1);
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 2px 8px 12px rgba(0, 0, 0, 0.12);
}

.timeline-icon img {
  width: 10px;
  height: 10px;
}

.timeline-content {
  padding-left: 20px;
}

.dropdown {
  position: relative;
  display: inline-block;
  width: 200px;
}

.dropdown-btn {
  background-color: white;
  border: 1px solid rgba(0, 0, 0, 0.16);
  border-radius: 50px;
  padding: 4px 20px 4px 12px;
  /* extra right padding for the arrow */
  cursor: pointer;
  position: relative;
}

.dropdown-btn::after {
  content: "‚ñº";
  /* arrow symbol */
  font-size: 12px;
  color: #333;
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  min-width: 100%;
  border-radius: 12px;
  box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
  z-index: 1;
  margin-top: 4px;
}

.dropdown-content a {
  padding: 8px 12px;
  display: block;
  text-decoration: none;
  color: black;
  border-radius: 8px;
}

.dropdown-content a:hover {
  background-color: #f1f1f1;
}

.dropdown.show .dropdown-content {
  display: block;
}

.badge-readonly {
  background-color: #f0f0f0;
  color: #666;
  font-weight: 600;
  font-size: 0.75rem;
  padding: 4px 8px;
  border-radius: 8px;
}
</style>