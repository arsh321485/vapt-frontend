<template>
  <main>
    <section>
      <div class="container-fluid px-0">
        <div class="row gx-0 no-gutters">
          <DashboardHeader />
        </div>
        <div class="row">
          <div class="col-1 ps-0 menubar-col1">
            <DashboardMenu />
          </div>

          <div class="col-11 pt-5 mt-2 pb-3 px-4 pe-5">
            <div class="d-flex justify-content-between">
              <h2 class="ticket-head mt-3">Vulnerability register</h2>
              <div class="d-flex flex-row gap-3 mt-3">
                <div>
                  <button class="btn fw-semibold px-3 py-2"
                    style="border-radius: 20px;border: 1px solid rgba(0, 0, 0, 0.12);color: rgba(49, 33, 177, 1);"
                    @click="showReport = true"><i class="bi bi-download me-2"></i> Download Report</button>
                </div>

                <!-- Overlay Popup -->
                <div v-if="showReport"
                  class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
                  style="background-color: rgba(0, 0, 0, 0.6); z-index: 1050;">
                  <div class="bg-white p-4 rounded shadow"
                    style="width: 600px; max-height: 90vh; overflow-y: auto; position: relative;">
                    <!-- Close Button -->
                    <button @click="showReport = false" class="btn-close position-absolute top-0 end-0 m-3"
                      aria-label="Close"></button>

                    <!-- Heading -->
                    <h2 class="mb-2 text-center">Download Report</h2>
                    <p class="mb-2 text-center" style="color: rgba(0, 0, 0, 0.6);font-weight: 500;font-size: 13px;">
                      Download report</p>
                    <button type="button" class="btn patch-btn rounded-pill text-nowrap ms-3 mb-3">
                      June 1 - June 30 <i class="bi bi-calendar-minus"></i>
                    </button>

                    <!-- Accordion -->
                    <div class="accordion" id="globalReportAccordion">
                      <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                          <button class="accordion-button" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                            Assets(11) <span class="text-primary ms-2">4 selected</span>
                          </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne"
                          data-bs-parent="#globalReportAccordion">
                          <div class="accordion-body">
                            Assets
                          </div>
                        </div>
                      </div>

                      <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTwo">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                            Vulnerabilities
                          </button>
                        </h2>
                        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo"
                          data-bs-parent="#globalReportAccordion">
                          <div class="accordion-body">
                            Vulnerabilities
                          </div>
                        </div>
                      </div>

                      <div class="accordion-item">
                        <h2 class="accordion-header" id="headingThree">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                            Team Role
                          </button>
                        </h2>
                        <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree"
                          data-bs-parent="#globalReportAccordion">
                          <div class="accordion-body">
                            Team Roles
                          </div>
                        </div>
                      </div>


                    </div>

                    <button class="btn download-btn btn-sm ms-3 mt-4"><i class="bi bi-download me-2"></i> Download
                      report</button>

                  </div>
                </div>

                

                <NotificationPanel />

              </div>
            </div>

            <div class="row mt-4">
              <div class="d-flex gap-3">

                <button class="btn btn-pill fw-semibold text-dark"
                  :class="activeFilter === 'All' ? 'btn-primary active-tab' : 'btn-outline-secondary'"
                  @click="setFilter('All')">
                  All
                </button>

                <button class="btn btn-pill fw-semibold"
                  :class="activeFilter === 'Critical' ? 'btn-primary active-tab' : 'btn-outline-secondary'"
                  style="color: maroon;" @click="setFilter('Critical')">
                  Critical
                </button>

                <button class="btn btn-pill fw-semibold"
                  :class="activeFilter === 'High' ? 'btn-primary active-tab' : 'btn-outline-secondary'"
                  style="color: red;" @click="setFilter('High')">
                  High
                </button>

                <button class="btn btn-pill fw-semibold"
                  :class="activeFilter === 'Medium' ? 'btn-primary active-tab' : 'btn-outline-secondary'"
                  style="color: orange;" @click="setFilter('Medium')">
                  Medium
                </button>

                <button class="btn btn-pill fw-semibold"
                  :class="activeFilter === 'Low' ? 'btn-primary active-tab' : 'btn-outline-secondary'"
                  style="color: green;" @click="setFilter('Low')">
                  Low
                </button>

                <button class="btn btn-outline-secondary btn-pill text-dark">June 1 - June 30 <i
                    class="bi bi-calendar-minus ms-2"></i>
                </button>
                <div class="mb-3">
                  <select class="form-select border border-secondary"
                    style="border-radius: 50px;color: rgba(130, 91, 0, 1);" v-model="statusFilter">
                    <option disabled value="">Status</option>

                    <option value="open" class="text-danger fw-semibold">
                      Open Vulnerabilities
                    </option>

                    <option value="closed" class="text-success fw-semibold">
                      Close Vulnerabilities
                    </option>

                    <option value="both" class="text-primary fw-semibold">
                      Both
                    </option>
                  </select>
                </div>
                <!-- <div>
                  <button class="btn text-light rounded-pill btn-sm mt-1"
                    style="background-color: rgba(49, 33, 177, 1); ;"><i class="bi bi-eye me-1"></i>View Report</button>
                </div> -->
              </div>
            </div>
            <div class="row mt-5">
              <div class="table-responsive">
                <table class="table align-middle table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>S.NO.</th>
                      <th>Vul. name</th>
                      <th>Asset</th>
                      <th>Severity</th>
                      <th>First Observation</th>
                      <th>Second Observation</th>
                      <th>Status</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody class="raised-tbody">
                    <tr v-for="(item, index) in filteredRows" :key="index">
                      <td>{{ index + 1 }}</td>

                      <td class="text-truncate" style="max-width: 200px;">
                        {{ item.vul_name }}
                      </td>

                      <td>{{ item.asset }}</td>

                      <td :style="{ color: getSeverityColor(item.severity) }">
                        {{ item.severity }}
                      </td>

                      <td>{{ formatDate(item.first_observation) }}</td>

                      <td>{{ item.second_observation ? formatDate(item.second_observation) : '' }}</td>

                      <td :class="getStatusClass(item.status)">{{ item.status }}</td>
                      <td>
  <router-link
  v-if="authStore.latestReportId"
  :to="{
    name: 'VulFix',
    params: {
      reportId: authStore.latestReportId,
      asset: item.asset,
    },
    query: {
      id: item.id,
      plugin_name: item.vul_name,
      risk_factor: item.severity
    }
  }"
  class="fw-semibold"
  style="text-decoration:none;color:rgba(49,33,177,1);"
>
  Fix Now <i class="bi bi-arrow-right-circle-fill ms-2"></i>
</router-link>

</td>

                      <!-- <td>
  <router-link
  v-if="reportId"
  :to="{ name: 'VulFix', params: { reportId: reportId, asset: item.asset }, query: { plugin_name: item.vul_name, risk_factor: item.severity } }"
  class="fw-semibold"
  style="text-decoration:none;color:rgba(49,33,177,1);"
>
  Fix Now <i class="bi bi-arrow-right-circle-fill ms-2"></i>
</router-link>
</td> -->

                      <!-- <td>
                        <router-link to="/vulnerabilitycard" style="text-decoration: none;">
                          <button class="btn fw-semibold border-0" style="color: rgba(49,33,177,1);">
                            Fix Now <i class="bi bi-arrow-right-circle-fill ms-2"></i>
                          </button>
                          
                        </router-link>
                      </td> -->
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </div>
      </div>

    </section>
  </main>
</template>

<script>
import DashboardMenu from '@/components/admin-component/DashboardMenu.vue';
import DashboardHeader from '@/components/admin-component/DashboardHeader.vue';
import NotificationPanel from "@/components/admin-component/NotificationPanel.vue";
import { useAuthStore } from "@/stores/authStore";
export default {
  name: 'VulnerabilityRegisterView',
  components: {
    DashboardMenu,
    DashboardHeader,
    NotificationPanel
  },
  data() {
    return {
      showReport: false,
      authStore: useAuthStore(),
      activeFilter: "All",
      statusFilter: "both",
      severityOrder: {
        Critical: 1,
        High: 2,
        Medium: 3,
        Low: 4,
      },
      reportId: null,
    };
  },
  computed: {
    filteredRows() {
      let rows = [...this.authStore.vulnerabilityRows];

      // Status filter
      if (this.statusFilter === "open") {
        rows = rows.filter(
          item => item.status?.toLowerCase() === "open"
        );
      } else if (this.statusFilter === "closed") {
        rows = rows.filter(
          item => item.status?.toLowerCase() === "closed" || item.status?.toLowerCase() === "close"
        );
      }
      // "both" â†’ no status filtering

      // Severity filter
      if (this.activeFilter !== "All") {
        rows = rows.filter(
          item => item.severity === this.activeFilter
        );
      }

      // Sort by severity priority
      return rows.sort((a, b) => {
        const aOrder = this.severityOrder[a.severity] ?? 99;
        const bOrder = this.severityOrder[b.severity] ?? 99;
        return aOrder - bOrder;
      });
    },
    filteredVulns() {
      if (this.selectedSeverity === "All") {
        return this.authStore.vulnerabilityRows;
      }
      return this.authStore.vulnerabilityRows.filter(
        (item) => item.severity === this.selectedSeverity
      );
    },

  },
  methods: {
    async loadVulnerabilities() {
      console.log("[VulnsPage] Calling fetchVulnerabilityRegister...");
      await this.authStore.fetchVulnerabilityRegister();
    },
    setFilter(type) {
      this.activeFilter = type; // â­ update selected tab
    },
    getSeverityColor(sev) {
      if (sev === "Critical") return "maroon";
      if (sev === "High") return "red";
      if (sev === "Medium") return "orange";
      return "green";
    },
    formatDate(date) {
      if (!date) return "";
      return new Date(date).toLocaleDateString("en-GB");
    },
    getStatusClass(status) {
      const statusLower = status?.toLowerCase();
      if (statusLower === 'closed' || statusLower === 'close') {
        return 'text-success fw-semibold text-capitalize';
      }
      if (statusLower === 'open') {
        return 'text-danger fw-semibold text-capitalize';
      }
      return 'text-capitalize';
    },
    goToFix(asset) {
  if (!asset || !this.reportId) return;

  this.$router.push({
    name: "VulFix",
    params: {
      reportId: this.reportId,
      asset
    }
  });
    }

  },
  mounted() {
  console.log("ðŸ”¥ Register page mounted");

  // Tooltip init (safe)
  const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
  if (tooltipTriggerList.length) {
    [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));
  }

  // Dropdown init (safe like Assets page)
  const dropdown = document.querySelector('.dropdown');

  if (dropdown) {
    const btn = dropdown.querySelector('.dropdown-btn');
    const options = dropdown.querySelectorAll('.dropdown-content a');

    if (btn) {
      btn.addEventListener('click', () => {
        dropdown.classList.toggle('show');
      });
    }

    options.forEach(option => {
      option.addEventListener('click', (e) => {
        e.preventDefault();
        if (btn) btn.textContent = option.textContent;
        dropdown.classList.remove('show');
      });
    });

    document.addEventListener('click', (e) => {
      if (!dropdown.contains(e.target)) {
        dropdown.classList.remove('show');
      }
    });
  }

  // ðŸ”¥ MAIN API CALL â€” clear stale data first so closed vulns don't flash
  this.authStore.vulnerabilityRows = [];
  if (typeof this.authStore.fetchVulnerabilityRegister === 'function') {
    console.log("ðŸ“¡ Calling vulnerabilities API...");
    this.authStore.fetchVulnerabilityRegister();
  } else {
    console.error("fetchVulnerabilityRegister not found in store");
  }
  },
};
</script>

<style scoped>
.ticket-head {
  color: rgba(0, 0, 0, 1);
  font-weight: 500;
  font-size: 36px;
}

.raised-table tr th {
  color: rgba(0, 0, 0, 0.6);
  font-weight: 500;
}

.raised-tbody tr td {
  color: rgba(0, 0, 0, 1);
  font-weight: 500;
}

.fixes-btn {
  color: rgba(49, 33, 177, 1);
  font-weight: 600;
}

.fixes-btn {
  color: rgba(49, 33, 177, 1);
  font-weight: 600;
}

.btn-pill {
  border-radius: 50px;
  padding: 6px 20px;
  font-size: 0.875rem;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  white-space: nowrap;
  height: 36px;
}

.active-tab {
  background-color: #E6E3FF;
  color: #3121B1;
  border: none;
  font-size: 13px;
}

.btn-outline-secondary:hover {
  background-color: transparent;
}

.download-btn {
  font-weight: 600;
  font-size: 12px;
  padding: 8px 15px;
  color: white;
  background-color: rgba(49, 33, 177, 1);
  border-radius: 30px;
  border: 1px solid rgba(0, 0, 0, 0.12);
}

.dropdown {
  position: relative;
  display: inline-block;
  width: 200px;
}

.dropdown-btn {
  background-color: white;
  border: 1px solid rgba(0, 0, 0, 0.16);
  border-radius: 50px;
  padding: 8px 40px 8px 16px;
  /* extra right padding for the arrow */
  cursor: pointer;
  position: relative;
}

.dropdown-btn::after {
  content: "â–¼";
  /* arrow symbol */
  font-size: 12px;
  color: #333;
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: white;
  min-width: 100%;
  border-radius: 12px;
  box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2);
  z-index: 1;
  margin-top: 4px;
}

.dropdown-content a {
  padding: 8px 12px;
  display: block;
  text-decoration: none;
  color: black;
  border-radius: 8px;
}

.dropdown-content a:hover {
  background-color: #f1f1f1;
}

.dropdown.show .dropdown-content {
  display: block;
}
</style>